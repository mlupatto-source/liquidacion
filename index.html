<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Liquidación Marcelo Lupatto</title>

<link rel="manifest" href="manifest.json">

<style>
body{
    font-family:Arial;
    background:linear-gradient(135deg,#1b5e20,#66bb6a);
    padding:20px;
    color:#1b5e20;
}
h1{
    text-align:center;
    color:white;
}
.container{
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
}
input,select{
    width:100%;
    padding:10px;
    margin-bottom:12px;
    font-size:16px;
    border-radius:8px;
    border:1px solid #ccc;
}
button{
    width:100%;
    padding:12px;
    margin-top:10px;
    border:none;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
}
.green{
    background:#2e7d32;
    color:white;
}
.gray{
    background:#616161;
    color:white;
}
.total{
    font-size:24px;
    font-weight:bold;
    color:black;
    margin-top:10px;
}
</style>
</head>
<body>

<h1>Marcelo Lupatto<br>Liquidación</h1>

<div class="container">

<!-- NUEVO: Tabla CLIENTE, editable y con 5 opciones -->
<h3>Cliente</h3>
<select id="clienteSeleccionado" onchange="guardarCliente()">
    <option value="">--Seleccione Cliente--</option>
    <option value="Cliente1">Cliente 1</option>
    <option value="Cliente2">Cliente 2</option>
    <option value="Cliente3">Cliente 3</option>
    <option value="Cliente4">Cliente 4</option>
    <option value="Cliente5">Cliente 5</option>
</select>

<!-- Tabla TIPO DE HORA -->
<h3>Tipo de Hora</h3>
<select id="tipoHora" onchange="calcular()">
    <option value="normal">Hora Normal</option>
    <option value="especial">Hora Especial</option>
</select>

Valor Hora Normal:
<input type="number" id="valorHora" value="14000" oninput="guardarValor('valorHora')">

Valor Hora Especial:
<input type="number" id="valorHoraEsp" value="18000" oninput="guardarValor('valorHoraEsp')">

Valor Kilómetro:
<input type="number" id="valorKm" value="600" oninput="guardarValor('valorKm')">

Horas:
<input type="number" id="horas" value="0" oninput="calcular()">

Kilómetros:
<input type="number" id="km" value="0" oninput="calcular()">

Otros:
<input type="number" id="otros" value="0" oninput="calcular()">

<!-- NUEVO: Tabla FORMA DE COBRO, editable, 5 opciones -->
<h3>Forma de Cobro</h3>
<select id="formaSeleccionada" onchange="guardarForma()">
    <option value="">No incluir</option>
    <option value="Efectivo">Efectivo</option>
    <option value="Transferencia">Transferencia</option>
    <option value="Cheque">Cheque</option>
    <option value="MercadoPago">MercadoPago</option>
    <option value="Otro">Otro</option>
</select>

<div id="total" class="total"></div>

<button class="gray" onclick="reiniciar()">Reiniciar</button>
<button class="green" onclick="generar()">Compartir por WhatsApp</button>
<button onclick="generarPDF()">Generar PDF</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>

// Guardar y recuperar datos de LocalStorage para persistencia
function guardarCliente(){
    localStorage.setItem("clienteSeleccionado", document.getElementById("clienteSeleccionado").value);
}
function guardarForma(){
    localStorage.setItem("formaCobroSeleccionada", document.getElementById("formaSeleccionada").value);
}
function guardarValor(id){
    localStorage.setItem(id, document.getElementById(id).value);
}

// Cargar valores guardados al iniciar
window.onload = function(){
    const cliente = localStorage.getItem("clienteSeleccionado");
    if(cliente) document.getElementById("clienteSeleccionado").value = cliente;

    const forma = localStorage.getItem("formaCobroSeleccionada");
    if(forma) document.getElementById("formaSeleccionada").value = forma;

    ['valorHora','valorHoraEsp','valorKm'].forEach(id=>{
        const v = localStorage.getItem(id);
        if(v) document.getElementById(id).value = v;
    });

    calcular();
};

// Formateo de números
function formato(n){
    return new Intl.NumberFormat('es-AR').format(n);
}

// Obtener valor hora según tipo
function obtenerValorHora(){
    let tipo=document.getElementById("tipoHora").value;
    let normal=parseFloat(document.getElementById("valorHora").value)||0;
    let esp=parseFloat(document.getElementById("valorHoraEsp").value)||0;
    return tipo==="normal"?normal:esp;
}

// Calcular total
function calcular(){
    let vh=obtenerValorHora();
    let vk=parseFloat(document.getElementById("valorKm").value)||0;
    let h=parseFloat(document.getElementById("horas").value)||0;
    let k=parseFloat(document.getElementById("km").value)||0;
    let o=parseFloat(document.getElementById("otros").value)||0;
    let total=(h*vh)+(k*vk)+o;
    document.getElementById("total").innerHTML="TOTAL: $"+formato(total);
    document.getElementById("totalFinal")?.remove(); // remover si existía
    let div = document.createElement('div');
    div.id='totalFinal';
    div.style.display='none';
    div.innerText=total;
    document.body.appendChild(div);
}

// Reiniciar valores
function reiniciar(){
    document.getElementById("horas").value=0;
    document.getElementById("km").value=0;
    document.getElementById("otros").value=0;
    calcular();
}

// Compartir por WhatsApp
function generar(){
    let fecha=new Date().toLocaleDateString('es-AR');
    let h=document.getElementById("horas").value;
    let k=document.getElementById("km").value;
    let o=document.getElementById("otros").value;
    let total=document.getElementById("total").innerText;
    let forma=document.getElementById("formaSeleccionada").value;
    let cliente=document.getElementById("clienteSeleccionado").value;

    let texto=
`LIQUIDACION ${fecha}
${cliente?cliente:""}

HORAS
Cantidad: ${h}

KILÓMETROS
Cantidad: ${k}

${total}

${forma? "FORMA DE PAGO: "+forma.toUpperCase() : ""}

Muchas gracias`;

    navigator.share({text:texto});
    calcular();
}

// Generar PDF
async function generarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const fecha = new Date().toLocaleDateString();
    const cliente = document.getElementById("clienteSeleccionado").value || "";
    const horas = document.getElementById("horas").value || "0";
    const kilometros = document.getElementById("km").value || "0";
    const total = document.getElementById("totalFinal").innerText || "0";
    const formaPago = (document.getElementById("formaSeleccionada").value || "").toUpperCase();

    // Logo
    const img = new Image();
    img.src = "icon.png";
    img.onload = function(){
        // Logo centrado
        doc.addImage(img,"PNG",80,10,50,30);
        // Nombre debajo del logo
        doc.setFont("helvetica","bold");
        doc.setFontSize(14);
        doc.text("Marcelo Lupatto",105,50,{align:"center"});

        doc.setFont("helvetica","normal");
        doc.setFontSize(11);
        // Fecha y cliente
        doc.text("Fecha: "+fecha,20,70);
        doc.text(cliente,20,78);

        // Horas y km
        doc.text("HORAS",20,95);
        doc.text("Cantidad: "+horas,25,103);

        doc.text("KILÓMETROS",20,115);
        doc.text("Cantidad: "+kilometros,25,123);

        // Total
        doc.setFont("helvetica","bold");
        doc.text("TOTAL: $"+total,20,140);

        // Forma de pago en mayúscula
        doc.setFont("helvetica","normal");
        doc.text("FORMA DE PAGO: "+formaPago,20,155);

        doc.save("Liquidacion.pdf");
    };
}

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js');
}

</script>
</body>
</html>
